<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบติดตามอุณหภูมิ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            padding: 20px;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 24px;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .temp-display {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .temp-item {
            text-align: center;
            flex: 1;
        }
        
        .temp-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .temp-label {
            font-size: 14px;
            color: #7f8c8d;
        }
        
        .temp-unit {
            font-size: 18px;
            vertical-align: super;
        }
        
        .motor-temp {
            color: #e74c3c;
        }
        
        .ambient-temp {
            color: #3498db;
        }
        
        .humidity {
            color: #9b59b6;
        }
        
        .fan-status {
            text-align: center;
            margin-top: 10px;
        }
        
        .fan-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .fan-label {
            font-size: 14px;
            color: #7f8c8d;
        }
        
        .fan-on {
            color: #2ecc71;
        }
        
        .fan-off {
            color: #e74c3c;
        }
        
        .chart-container {
            height: 250px;
            margin-top: 10px;
        }
        
        .status-indicator {
            display: flex;
            justify-content: center;
            margin-top: 15px;
        }
        
        .indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin: 0 5px;
        }
        
        .indicator.active {
            background-color: #2ecc71;
        }
        
        .indicator.inactive {
            background-color: #e74c3c;
        }
        
        .update-time {
            text-align: center;
            font-size: 12px;
            color: #95a5a6;
            margin-top: 10px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }
        
        .error {
            text-align: center;
            padding: 10px;
            color: #e74c3c;
            background-color: #fadbd8;
            border-radius: 5px;
            margin-top: 10px;
        }
        
        .no-data {
            color: #95a5a6;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ระบบติดตามอุณหภูมิ</h1>
        <p>การพัฒนาระบบควบคุมพัดลมระบายความร้อนอัตโนมัติสำหรับมอเตอร์โดยใช้ไมโครคอนโทรลเลอร์และเซนเซอร์วัดอุณหภูมิ</p>
    </div>
    
    <div class="card">
        <div class="card-title">อุณหภูมิปัจจุบัน</div>
        <div class="temp-display">
            <div class="temp-item">
                <div class="temp-value motor-temp" id="motorTemp">--</div>
                <div class="temp-label">Motor Temp. °C</div>
            </div>
            <div class="temp-item">
                <div class="temp-value ambient-temp" id="ambientTemp">--</div>
                <div class="temp-label">Ambient Temp. °C</div>
            </div>
            <div class="temp-item">
                <div class="temp-value humidity" id="humidity">--</div>
                <div class="temp-label">Humidity %</div>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-title">สถานะพัดลม</div>
        <div class="fan-status">
            <div class="fan-value fan-off" id="fanStatus">--%</div>
            <div class="fan-label">Fan Status</div>
        </div>
        <div class="status-indicator">
            <div class="indicator inactive" id="indicator1"></div>
            <div class="indicator inactive" id="indicator2"></div>
            <div class="indicator inactive" id="indicator3"></div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-title">กราฟอุณหภูมิ</div>
        <div class="chart-container">
            <canvas id="tempChart"></canvas>
        </div>
    </div>
    
    <div class="update-time" id="updateTime">
        อัพเดตล่าสุด: กำลังโหลด...
    </div>
    
    <div id="errorMessage" class="error" style="display: none;"></div>

    <script>
        // ตัวแปรสำหรับเก็บข้อมูล
        let motorTempHistory = [];
        let ambientTempHistory = [];
        let humidityHistory = [];
        let timeLabels = [];
        const maxDataPoints = 20; // จำนวนจุดข้อมูลสูงสุดในกราฟ
        
        // ตั้งค่ากราฟ
        const ctx = document.getElementById('tempChart').getContext('2d');
        const tempChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [
                    {
                        label: 'Motor Temp (°C)',
                        data: motorTempHistory,
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Ambient Temp (°C)',
                        data: ambientTempHistory,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Humidity (%)',
                        data: humidityHistory,
                        borderColor: '#9b59b6',
                        backgroundColor: 'rgba(155, 89, 182, 0.1)',
                        tension: 0.4,
                        fill: true,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'อุณหภูมิ (°C)'
                        },
                        suggestedMin: 20,
                        suggestedMax: 80
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'ความชื้น (%)'
                        },
                        suggestedMin: 0,
                        suggestedMax: 100,
                        grid: {
                            drawOnChartArea: false,
                        },
                    }
                }
            }
        });

        // ฟังก์ชันดึงข้อมูลจาก Thinger.io
        async function fetchDataFromThinger() {
            try {
                // ใช้ Thing HTTP API ของ Thinger.io เวอร์ชัน v3
                const response = await fetch('https://backend.thinger.io/v3/users/Yout45/devices/Tarn/resources/temp_data', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJkZXYiOiJUYXJuIiwiaWF0IjoxNzYyNDIxNjM1LCJqdGkiOiI2OTBjNmI4M2UzMjRhZjk4ZmQwNDU2MTciLCJzdnIiOiJhcC1zb3V0aGVhc3QuYXdzLnRoaW5nZXIuaW8iLCJ1c3IiOiJZb3V0NDUifQ.j73FDe2nQNVh2hlUM_xlB2GXPvby5yilxt-IYEIF8Y8',
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching data:', error);
                throw error;
            }
        }

        // ฟังก์ชันจัดการข้อมูล null
        function handleNullData(value, defaultValue = 0) {
            return value === null ? defaultValue : value;
        }

        // ฟังก์ชันอัพเดตข้อมูล
        async function updateData() {
            try {
                const data = await fetchDataFromThinger();
                
                // จัดการข้อมูล null
                const motorTemp = handleNullData(data.motorTemp, 0);
                const ambientTemp = handleNullData(data.ambientTemp, 0);
                const humidity = handleNullData(data.humidity, 0);
                const fanStatus = handleNullData(data.fanStatus, 0);
                
                // อัพเดตข้อมูลบนหน้าเว็บ
                document.getElementById('motorTemp').textContent = motorTemp.toFixed(1);
                document.getElementById('ambientTemp').textContent = ambientTemp > 0 ? ambientTemp.toFixed(1) : 'N/A';
                document.getElementById('humidity').textContent = humidity > 0 ? humidity.toFixed(0) : 'N/A';
                document.getElementById('fanStatus').textContent = fanStatus + '%';
                
                // เพิ่มคลาส no-data ถ้าข้อมูลเป็น 0
                if (ambientTemp === 0) {
                    document.getElementById('ambientTemp').classList.add('no-data');
                } else {
                    document.getElementById('ambientTemp').classList.remove('no-data');
                }
                
                if (humidity === 0) {
                    document.getElementById('humidity').classList.add('no-data');
                } else {
                    document.getElementById('humidity').classList.remove('no-data');
                }
                
                // อัพเดตสีสถานะพัดลม
                const fanStatusElement = document.getElementById('fanStatus');
                if (fanStatus === 0) {
                    fanStatusElement.classList.remove('fan-on');
                    fanStatusElement.classList.add('fan-off');
                } else {
                    fanStatusElement.classList.remove('fan-off');
                    fanStatusElement.classList.add('fan-on');
                }
                
                // อัพเดตอินดิเคเตอร์
                const indicators = document.querySelectorAll('.indicator');
                if (fanStatus === 0) {
                    indicators.forEach(indicator => {
                        indicator.classList.remove('active');
                        indicator.classList.add('inactive');
                    });
                } else {
                    indicators.forEach(indicator => {
                        indicator.classList.remove('inactive');
                        indicator.classList.add('active');
                    });
                }
                
                // อัพเดตกราฟ (เฉพาะข้อมูลที่ไม่เป็น 0)
                const currentTime = new Date();
                const timeLabel = `${currentTime.getHours()}:${currentTime.getMinutes().toString().padStart(2, '0')}`;
                
                // เพิ่มข้อมูลใหม่
                timeLabels.push(timeLabel);
                motorTempHistory.push(motorTemp);
                // เพิ่มข้อมูล ambientTemp และ humidity เฉพาะเมื่อมีค่าจริง
                ambientTempHistory.push(ambientTemp > 0 ? ambientTemp : null);
                humidityHistory.push(humidity > 0 ? humidity : null);
                
                // จำกัดจำนวนจุดข้อมูลในกราฟ
                if (timeLabels.length > maxDataPoints) {
                    timeLabels.shift();
                    motorTempHistory.shift();
                    ambientTempHistory.shift();
                    humidityHistory.shift();
                }
                
                // อัพเดตข้อมูลในกราฟ
                tempChart.data.labels = timeLabels;
                tempChart.data.datasets[0].data = motorTempHistory;
                tempChart.data.datasets[1].data = ambientTempHistory;
                tempChart.data.datasets[2].data = humidityHistory;
                
                tempChart.update();
                
                // อัพเดตเวลาล่าสุด
                document.getElementById('updateTime').textContent = 
                    `อัพเดตล่าสุด: ${currentTime.toLocaleTimeString('th-TH')}`;
                
                // ซ่อนข้อความผิดพลาดถ้ามี
                document.getElementById('errorMessage').style.display = 'none';
                
            } catch (error) {
                console.error('Error updating data:', error);
                document.getElementById('errorMessage').textContent = 
                    'เกิดข้อผิดพลาดในการดึงข้อมูล: ' + error.message;
                document.getElementById('errorMessage').style.display = 'block';
            }
        }

        // อัพเดตข้อมูลทุก 5 วินาที (ปรับจาก 200ms เป็น 5000ms)
        setInterval(updateData, 5000);
        
        // อัพเดตข้อมูลทันทีเมื่อโหลดหน้าเว็บ
        updateData();
    </script>
</body>
</html>
